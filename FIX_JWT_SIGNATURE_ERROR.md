# Fix JWT Signature Error

The error "invalid JWT: unable to parse or verify signature" happens when the magic link token was signed by a different Supabase instance than the one your frontend is connected to.

## Quick Fix

### Step 1: Restart Supabase (if running locally)

If you're running Supabase locally, restart it to ensure everything is in sync:

```bash
supabase stop
supabase start
```

This resets the JWT secret and ensures your local instance is fresh.

### Step 2: Clear Browser Storage

Clear any stale tokens from your browser:

1. Open browser DevTools (F12)
2. Go to **Application** tab (Chrome) or **Storage** tab (Firefox)
3. Under **Local Storage**, find your site's domain
4. Delete all entries (or just look for `sb-*` keys and delete those)
5. Also clear **Session Storage** if present

Or use the console:
```javascript
localStorage.clear();
sessionStorage.clear();
```

### Step 3: Request a Fresh Magic Link

1. Go back to the login page
2. Enter your email again
3. Click "Send magic link"
4. Get the **new** magic link from Mailpit (http://localhost:8025)
5. Click the new link

## Common Causes

### Cause 1: Supabase Instance Mismatch

**Problem**: Your frontend is connected to one Supabase instance, but the magic link was generated by another.

**Check**:
- Open browser console
- Look for the log: `[supabase] connected: ...`
- Verify it matches your local Supabase URL: `http://localhost:54321`

**Fix**: Make sure your `.env.local` or `.env` has:
```env
VITE_SUPABASE_URL=http://localhost:54321
VITE_SUPABASE_ANON_KEY=your-local-anon-key
```

### Cause 2: Supabase Restarted

**Problem**: You restarted Supabase, which changed the JWT secret. Old magic links are now invalid.

**Fix**: Request a new magic link after restarting Supabase.

### Cause 3: Stale Browser Session

**Problem**: Your browser has old tokens that don't match the current Supabase instance.

**Fix**: Clear browser storage (see Step 2 above).

## Verify Your Setup

1. **Check Supabase is running:**
   ```bash
   supabase status
   ```

2. **Check your environment variables:**
   - Make sure `.env.local` exists
   - Verify `VITE_SUPABASE_URL` points to `http://localhost:54321` (for local dev)
   - Get the anon key from `supabase status` output

3. **Check browser console:**
   - Look for `[supabase] connected: http://localhost:54321`
   - If it shows a different URL, your env vars are wrong

## Still Not Working?

If you're still getting the error after trying the above:

1. **Completely restart everything:**
   ```bash
   # Stop Supabase
   supabase stop
   
   # Clear browser storage
   # (use DevTools or console: localStorage.clear())
   
   # Start Supabase fresh
   supabase start
   
   # Restart your dev server
   # (stop with Ctrl+C, then npm run dev)
   ```

2. **Get a completely fresh magic link:**
   - Go to login page
   - Enter email
   - Get new link from Mailpit
   - Click the new link immediately

3. **Check Supabase logs:**
   ```bash
   supabase logs auth
   ```
   Look for any errors related to JWT validation.

## Production vs Local

If you're trying to use a production magic link on localhost (or vice versa), that won't work. Make sure:
- **Local dev**: Use magic links from local Supabase (Mailpit)
- **Production**: Use magic links from production Supabase (real email)

The JWT secret is different for each Supabase instance, so tokens are not interchangeable.



